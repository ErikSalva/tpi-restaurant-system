<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç≥ Tablero de Cocina</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .pedidos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .pedido-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.5s ease-out;
        }
        .estado-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin: 10px 0;
        }
        .estado-CONFIRMADO { background: #2196F3; }
        .estado-EN_PREPARACION { background: #FF9800; }
        .estado-LISTO { background: #4CAF50; }
        .estado-ENTREGADO { background: #9E9E9E; }
        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-preparar { background: #FF9800; color: white; }
        .btn-listo { background: #4CAF50; color: white; }
        .btn-entregar { background: #9E9E9E; color: white; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        .pedido-id {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
        }
        .pedido-items {
            margin: 10px 0;
        }
        .item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .timestamp {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 10px;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background-color: #4CAF50; }
        .btn-entregar { background: #9E9E9E; color: white; }
        .login-prompt {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .login-prompt input {
            padding: 10px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            width: 200px;
        }
        .login-prompt button {
            padding: 10px 20px;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç≥ Tablero de Cocina</h1>
            <p>Sistema de Pedidos en Tiempo Real</p>
        </div>
        
        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <h3>‚ö†Ô∏è Se requiere autenticaci√≥n</h3>
            <p>Por favor ingresa tus credenciales para cambiar estados de pedidos</p>
            <input type="email" id="emailInput" placeholder="admin@restaurante.com">
            <input type="password" id="passwordInput" placeholder="Contrase√±a">
            <button class="btn btn-preparar" onclick="loginCocina()">Iniciar Sesi√≥n</button>
        </div>
        
        <div class="status">
            <h3>Estado de Conexi√≥n</h3>
            <p>
                <span id="connectionStatus" class="connection-status disconnected"></span>
                <span id="connectionText">Desconectado</span>
            </p>
            <p>Pedidos recibidos: <span id="pedidosCount">0</span></p>
        </div>
        
        <div class="pedidos-container" id="pedidosContainer">
            <div class="pedido-card" style="text-align: center; opacity: 0.7;">
                <h3>‚è≥ Esperando pedidos...</h3>
                <p>Los pedidos confirmados aparecer√°n aqu√≠ autom√°ticamente</p>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let pedidosCount = 0;
        let token = localStorage.getItem('token_cocina');
        
        // Verificar si hay token al cargar
        if (!token) {
            document.getElementById('loginPrompt').style.display = 'block';
        }
        
        async function loginCocina() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            try {
                const response = await fetch('http://localhost:3000/auth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    localStorage.setItem('token_cocina', token);
                    document.getElementById('loginPrompt').style.display = 'none';
                    alert('‚úÖ Sesi√≥n iniciada correctamente');
                } else {
                    alert('‚ùå Credenciales incorrectas');
                }
            } catch (error) {
                console.error('Error en login:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('üîå Conectado al WebSocket');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('üì® Mensaje recibido:', message);
                
                if (message.type === 'pedido.confirmado' || message.type === 'pedido_confirmado') {
                    addPedido(message.data);
                } else if (message.type === 'pedido.estado_cambiado') {
                    updatePedidoEstado(message.data);
                } else if (message.type === 'welcome') {
                    console.log('üëã', message.message);
                }
            };
            
            ws.onclose = function() {
                console.log('üîå Conexi√≥n WebSocket cerrada');
                updateConnectionStatus(false);
                // Reconectar despu√©s de 3 segundos
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('‚ùå Error en WebSocket:', error);
                updateConnectionStatus(false);
            };
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                status.className = 'connection-status connected';
                text.textContent = 'Conectado';
            } else {
                status.className = 'connection-status disconnected';
                text.textContent = 'Desconectado';
            }
        }
        
        function getEstadoBadge(estado) {
            const estadoMap = {
                'CONFIRMADO': 'Confirmado',
                'EN_PREPARACION': 'En Preparaci√≥n',
                'LISTO': 'Listo',
                'ENTREGADO': 'Entregado'
            };
            return `<span class="estado-badge estado-${estado}">${estadoMap[estado] || estado}</span>`;
        }
        
        function getActionButtons(pedidoId, estado) {
            if (estado === 'CONFIRMADO') {
                return `<button class="btn btn-preparar" onclick="cambiarEstado('${pedidoId}', 'en-preparacion')">Iniciar Preparaci√≥n</button>`;
            } else if (estado === 'EN_PREPARACION') {
                return `<button class="btn btn-listo" onclick="cambiarEstado('${pedidoId}', 'listo')">Marcar Listo</button>`;
            } else if (estado === 'LISTO') {
                return `<span style="color: #4CAF50; font-weight: bold;">‚úì Listo para entregar</span>`;
            }
            return '';
        }
        
        async function cambiarEstado(pedidoId, accion) {
            try {
                if (!token) {
                    alert('No hay token de autenticaci√≥n. Por favor inicia sesi√≥n.');
                    document.getElementById('loginPrompt').style.display = 'block';
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/pedidos/${pedidoId}/${accion}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.message || 'No se pudo cambiar el estado'}`);
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                alert('Error de red al cambiar el estado del pedido');
            }
        }
        
        function updatePedidoEstado(data) {
            console.log('üîÑ Actualizando estado de pedido:', data);
            const card = document.querySelector(`[data-pedido-id="${data.pedidoId}"]`);
            console.log('üîç Tarjeta encontrada:', card ? 'S√≠' : 'No');
            
            if (card) {
                // Si el pedido fue entregado, removerlo del tablero de cocina
                if (data.estadoNuevo === 'ENTREGADO') {
                    console.log('‚úÖ Pedido entregado, removiendo de tablero cocina');
                    // Decrementar contador de pedidos inmediatamente
                    pedidosCount = Math.max(0, pedidosCount - 1);
                    document.getElementById('pedidosCount').textContent = pedidosCount;
                    console.log('üìä Contador actualizado:', pedidosCount);
                    
                    card.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        card.remove();
                        // Verificar si no quedan m√°s pedidos
                        const container = document.getElementById('pedidosContainer');
                        if (container.children.length === 0) {
                            container.innerHTML = `
                                <div class="pedido-card" style="text-align: center; opacity: 0.7;">
                                    <h3>‚è≥ Esperando pedidos...</h3>
                                    <p>Los pedidos confirmados aparecer√°n aqu√≠ autom√°ticamente</p>
                                </div>
                            `;
                        }
                    }, 300);
                    return;
                }
                
                const estadoBadge = card.querySelector('.estado-badge');
                if (estadoBadge) {
                    const estadoMap = {
                        'CONFIRMADO': 'Confirmado',
                        'EN_PREPARACION': 'En Preparaci√≥n',
                        'LISTO': 'Listo',
                        'ENTREGADO': 'Entregado'
                    };
                    estadoBadge.className = `estado-badge estado-${data.estadoNuevo}`;
                    estadoBadge.textContent = estadoMap[data.estadoNuevo] || data.estadoNuevo;
                }
                
                const actionsDiv = card.querySelector('.action-buttons');
                if (actionsDiv) {
                    console.log('‚úÖ Actualizando botones para estado:', data.estadoNuevo);
                    actionsDiv.innerHTML = getActionButtons(data.pedidoId, data.estadoNuevo);
                } else {
                    console.log('‚ö†Ô∏è No se encontr√≥ div de acciones');
                }
            } else {
                console.log('‚ö†Ô∏è No se encontr√≥ tarjeta con pedidoId:', data.pedidoId);
                // Si no encontramos la tarjeta, podr√≠a ser que el pedido a√∫n no est√© en la vista
                // En ese caso, no hacemos nada ya que aparecer√° cuando se confirme
            }
        }
        
        function addPedido(pedido) {
            pedidosCount++;
            document.getElementById('pedidosCount').textContent = pedidosCount;
            
            // Remover mensaje de espera si existe
            const container = document.getElementById('pedidosContainer');
            const waitingMsg = container.querySelector('.pedido-card[style*="opacity: 0.7"]');
            if (waitingMsg) {
                waitingMsg.remove();
            }
            
            // Formatear items
            const itemsHtml = pedido.items && Array.isArray(pedido.items) 
                ? pedido.items.map(item => `
                    <div class="item">
                        ${item.cantidad}x ${item.nombreProducto} - $${item.precioUnitario.toFixed(2)}
                    </div>
                  `).join('')
                : '<div class="item">Sin items</div>';
            
            // Crear tarjeta de pedido
            const pedidoCard = document.createElement('div');
            pedidoCard.className = 'pedido-card';
            pedidoCard.setAttribute('data-pedido-id', pedido.pedidoId);
            pedidoCard.innerHTML = `
                <div class="pedido-id">Pedido #${pedido.pedidoId ? pedido.pedidoId.slice(-8) : 'N/A'}</div>
                ${getEstadoBadge(pedido.estado || 'CONFIRMADO')}
                <div class="pedido-items">
                    ${itemsHtml}
                </div>
                <div class="timestamp">
                    Usuario: ${pedido.usuarioId ? pedido.usuarioId.slice(-8) : 'An√≥nimo'}<br>
                    Total: $${pedido.total ? pedido.total.toFixed(2) : '0.00'}<br>
                    Recibido: ${new Date(pedido.timestamp).toLocaleTimeString()}
                </div>
                <div class="action-buttons">
                    ${getActionButtons(pedido.pedidoId, pedido.estado || 'CONFIRMADO')}
                </div>
            `;
            
            // Agregar al inicio del contenedor
            container.insertBefore(pedidoCard, container.firstChild);
            
            // Limitar a 10 pedidos visibles
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }
        
        // Conectar al cargar la p√°gina
        connectWebSocket();
    </script>
</body>
</html>
